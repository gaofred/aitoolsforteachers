# å°æ•°ç‚¹æ•°æ”¯æŒè®¾ç½®æŒ‡å—

## æ¦‚è¿°
æœ¬é¡¹ç›®çš„æ•°æ®åº“ç°åœ¨æ”¯æŒå°æ•°ç‚¹æ•°ï¼Œå…è®¸è®¾ç½®æ›´ç²¾ç»†çš„ç‚¹æ•°æ¶ˆè€—ï¼Œå¦‚0.5ç‚¹æ•°ã€1.5ç‚¹æ•°ç­‰ã€‚

## å·²å®Œæˆçš„ä¿®æ”¹

### 1. æ•°æ®åº“æ¶æ„ä¿®æ”¹
æ–‡ä»¶ï¼š`update-database-for-decimal-points.sql`

**ä¿®æ”¹çš„è¡¨å’Œå­—æ®µï¼š**
- `user_points.points` â†’ NUMERIC(10,2)
- `point_transactions.amount` â†’ NUMERIC(10,2)
- `ai_generations.points_cost` â†’ NUMERIC(10,2)
- `ai_tool_configs.standard_cost` â†’ NUMERIC(10,2)
- `ai_tool_configs.pro_cost` â†’ NUMERIC(10,2)

### 2. æ•°æ®åº“å‡½æ•°æ›´æ–°
- `add_user_points()` - æ”¯æŒå°æ•°ç‚¹æ•°
- `deduct_user_points()` - æ”¯æŒå°æ•°ç‚¹æ•°
- `get_current_points()` - è¿”å›å°æ•°

### 3. æ–°å¢å°æ•°ç‚¹æ•°å·¥å…·é…ç½®
æ–‡ä»¶ï¼š`scripts/init-decimal-ai-tools.ts`

**æ–°å¢å·¥å…·ï¼š**
- OCRå›¾åƒè¯†åˆ«ï¼š0ç‚¹æ•°ï¼ˆå…è´¹ï¼‰
- å¿«é€Ÿè¯­æ³•æ£€æŸ¥ï¼š0.5ç‚¹æ•°
- å•è¯é‡Šä¹‰æŸ¥è¯¢ï¼š0.5ç‚¹æ•°
- å•å¥ç¿»è¯‘ï¼š0.5ç‚¹æ•°

## ä½¿ç”¨æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šåº”ç”¨æ•°æ®åº“ä¿®æ”¹
1. æ‰“å¼€Supabase SQLç¼–è¾‘å™¨
2. å¤åˆ¶å¹¶è¿è¡Œ `update-database-for-decimal-points.sql` ä¸­çš„æ‰€æœ‰SQLè¯­å¥
3. ç¡®è®¤æ‰€æœ‰è¡¨å­—æ®µéƒ½å·²æˆåŠŸä¿®æ”¹ä¸ºNUMERICç±»å‹

### ç¬¬äºŒæ­¥ï¼šåˆå§‹åŒ–å°æ•°ç‚¹æ•°å·¥å…·ï¼ˆå¯é€‰ï¼‰
```bash
# è¿è¡Œå°æ•°ç‚¹æ•°å·¥å…·åˆå§‹åŒ–è„šæœ¬
npm run ts-node scripts/init-decimal-ai-tools.ts
```

### ç¬¬ä¸‰æ­¥ï¼šåœ¨ä»£ç ä¸­ä½¿ç”¨å°æ•°ç‚¹æ•°
ç°åœ¨å¯ä»¥åœ¨APIè·¯ç”±ä¸­ç›´æ¥ä½¿ç”¨å°æ•°ç‚¹æ•°ï¼š

```typescript
// è¯­æ³•ç¤ºä¾‹
const pointsCost = 0.5; // åŠä¸ªç‚¹æ•°
const { error } = await supabase.rpc('deduct_user_points', {
  p_user_id: user.id,
  p_amount: pointsCost,
  p_description: 'å¿«é€Ÿè¯­æ³•æ£€æŸ¥'
});
```

## æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“å…¼å®¹æ€§**ï¼šç¡®ä¿ä½¿ç”¨NUMERIC(10,2)ç±»å‹ï¼Œæœ€å¤šæ”¯æŒ2ä½å°æ•°
2. **å‰ç«¯æ˜¾ç¤º**ï¼šå‰ç«¯éœ€è¦æ­£ç¡®æ˜¾ç¤ºå°æ•°ç‚¹æ•°ï¼Œå¦‚"0.5ç‚¹æ•°"
3. **è®¡ç®—ç²¾åº¦**ï¼šæ•°æ®åº“è®¡ç®—æ—¶æ³¨æ„æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜
4. **å‘åå…¼å®¹**ï¼šç°æœ‰çš„æ•´æ•°ç‚¹æ•°ä»ç„¶æ­£å¸¸å·¥ä½œ

## éªŒè¯æ–¹æ³•

1. **æ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„ï¼š**
```sql
SELECT column_name, data_type, numeric_precision, numeric_scale
FROM information_schema.columns
WHERE table_name = 'user_points' AND column_name = 'points';
```

2. **æµ‹è¯•å°æ•°ç‚¹æ•°æ“ä½œï¼š**
```sql
SELECT public.add_user_points(user_uuid, 0.5, 'BONUS', 'æµ‹è¯•å°æ•°ç‚¹æ•°');
SELECT public.get_current_points(user_uuid);
```

3. **æŸ¥çœ‹äº¤æ˜“è®°å½•ï¼š**
```sql
SELECT * FROM point_transactions WHERE amount = 0.5 OR amount = -0.5;
```

## æ•…éšœæ’é™¤

### å¸¸è§é”™è¯¯
1. **"invalid input syntax for type integer"**
   - åŸå› ï¼šæ•°æ®åº“å­—æ®µå°šæœªä¿®æ”¹ä¸ºNUMERICç±»å‹
   - è§£å†³ï¼šå…ˆè¿è¡Œæ•°æ®åº“ä¿®æ”¹è„šæœ¬

2. **å°æ•°ç‚¹æ•°æ˜¾ç¤ºå¼‚å¸¸**
   - åŸå› ï¼šå‰ç«¯æœªæ­£ç¡®å¤„ç†å°æ•°æ˜¾ç¤º
   - è§£å†³ï¼šæ›´æ–°æ˜¾ç¤ºé€»è¾‘æ”¯æŒå°æ•°

3. **å‡½æ•°æ‰§è¡Œå¤±è´¥**
   - åŸå› ï¼šæ•°æ®åº“å‡½æ•°æœªæ›´æ–°ä¸ºæ”¯æŒå°æ•°
   - è§£å†³ï¼šé‡æ–°åˆ›å»ºæ•°æ®åº“å‡½æ•°

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œç³»ç»Ÿå°±å®Œå…¨æ”¯æŒå°æ•°ç‚¹æ•°äº†ï¼ğŸ‰