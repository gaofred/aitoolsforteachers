service: english-teaching-tools

provider:
  name: tencent
  runtime: Nodejs18.x  # 关键：指定 Node.js 18.x 以兼容 Next.js 15.x
  region: ap-beijing
  environment:
    NODE_ENV: production
    STATIC_URL: ${self:custom.staticUrl}
  memorySize: 512
  timeout: 120

# 自定义配置
custom:
  # 静态文件URL配置
  staticUrl: https://${self:service}-${sls:stage}.cos.ap-beijing.myqcloud.com

  # Next.js 配置
  nextConfig:
    # 启用独立输出
    output: 'standalone'
    # 实验性功能
    experimental: {
      serverComponentsExternalPackages: ['@supabase/supabase-js']
    }

# 函数配置
functions:
  # Next.js 服务器函数
  server:
    handler: server.js
    runtime: Nodejs18.x
    memorySize: 1024
    timeout: 120
    events:
      - apigw:
          path: /{proxy+}
          method: ANY
          cors: true
    environment:
      NODE_ENV: production
      STATIC_URL: ${self:custom.staticUrl}

# 部署配置
package:
  # 独立输出模式，包含所有依赖
  artifact:
    exclude:
      - .git/**
      - .vscode/**
      - src/**  # 排除源代码，只使用构建输出
      - pages/** # 排除页面源代码
      - components/** # 排除组件源代码
      - app/** # 排除App Router源代码
      - '*.log'
      - .DS_Store
      - README.md
      - .env.local
      - node_modules/**/test/**
      - node_modules/**/tests/**
      - node_modules/**/*.md

# 阶段配置
stages:
  dev:
    environment:
      NODE_ENV: production
    memorySize: 512
    timeout: 120

  prod:
    environment:
      NODE_ENV: production
    memorySize: 1024
    timeout: 120

# 使用的插件
plugins:
  - serverless-offline  # 本地测试（可选）
  - serverless-dotenv-plugin  # 环境变量管理（可选）