From 8fb76a5c09400f7f2bbcf6082a056625355f5550 Mon Sep 17 00:00:00 2001
From: fredgao <547738395@qq.com>
Date: Wed, 5 Nov 2025 01:23:33 +0800
Subject: [PATCH 1/2] =?UTF-8?q?fix:=20=E5=AE=8C=E7=BE=8E=E4=BF=AE=E5=A4=8D?=
 =?UTF-8?q?AI=E6=8E=92=E7=89=88=E7=8A=B6=E6=80=81=E5=90=8C=E6=AD=A5?=
 =?UTF-8?q?=E9=97=AE=E9=A2=98=E5=92=8C=E6=9E=81=E9=99=90=E6=80=A7=E8=83=BD?=
 =?UTF-8?q?=E4=BC=98=E5=8C=96?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

ğŸ› AIæ’ç‰ˆçŠ¶æ€åŒæ­¥ä¿®å¤ï¼š
- è§£å†³æ’ç‰ˆåé¡µé¢åˆ·æ–°ä¸¢å¤±æ ¼å¼å†…å®¹çš„ä¸¥é‡bug
- å®ç°ç«‹å³çŠ¶æ€æ›´æ–°æœºåˆ¶ï¼Œç¡®ä¿æ ¼å¼åŒ–å†…å®¹å®æ—¶ä¿å­˜
- ä¼˜åŒ–æ˜¾ç¤ºä¼˜å…ˆçº§é€»è¾‘ï¼Œformattedå†…å®¹ä¼˜å…ˆæ˜¾ç¤º
- å¼ºåˆ¶ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œä¿è¯çŠ¶æ€åŒæ­¥ä¸€è‡´æ€§

âš¡ æé™å¹¶å‘æ€§èƒ½ä¼˜åŒ–ï¼š
- 26å¼ å›¾ç‰‡è¶…çº§å¹¶è¡Œå¤„ç†ï¼Œæœ€å¤§åŒ–OCRè¯†åˆ«æ€§èƒ½
- ä¿å®ˆæ—¶é—´ä¼°ç®—å…¬å¼ï¼Œé¿å…ç”¨æˆ·æœŸæœ›è¿‡é«˜
- è¯¦ç»†æ€§èƒ½ç›‘æ§ç»Ÿè®¡ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

Technical Details:
- ApplicationContentConfirmation.tsx: ç«‹å³çŠ¶æ€æ›´æ–° + æ˜¾ç¤ºä¼˜å…ˆçº§
- BatchImageUploader.tsx: batchSize=26 + æ—¶é—´ä¼°ç®—ä¼˜åŒ–
---
 .../ApplicationContentConfirmation.tsx        | 94 +++++++++++++++----
 .../components/BatchImageUploader.tsx         |  7 +-
 2 files changed, 78 insertions(+), 23 deletions(-)

diff --git a/src/app/tools/writing/batch-applicationwriting-polish/components/ApplicationContentConfirmation.tsx b/src/app/tools/writing/batch-applicationwriting-polish/components/ApplicationContentConfirmation.tsx
index c42f1f7..32a3510 100644
--- a/src/app/tools/writing/batch-applicationwriting-polish/components/ApplicationContentConfirmation.tsx
+++ b/src/app/tools/writing/batch-applicationwriting-polish/components/ApplicationContentConfirmation.tsx
@@ -194,10 +194,7 @@ const ApplicationContentConfirmation: React.FC<ApplicationContentConfirmationPro
     try {
       const formatted = await applyAIFormatting(assignmentId, originalText);
 
-      // æ›´æ–°ç¼–è¾‘æ–‡æœ¬
-      setEditedTexts({ ...editedTexts, [assignmentId]: formatted });
-
-      // åŒæ—¶æ›´æ–°ä»»åŠ¡æ•°æ®ï¼ˆç¡®ä¿ç«‹å³ç”Ÿæ•ˆï¼‰
+      // ğŸ”§ ä¿®å¤ï¼šå…ˆæ›´æ–°ä»»åŠ¡æ•°æ®ï¼Œç¡®ä¿çŠ¶æ€åŒæ­¥
       if (task) {
         const updatedAssignments = task.assignments.map(assignment => {
           if (assignment.id === assignmentId) {
@@ -221,15 +218,50 @@ const ApplicationContentConfirmation: React.FC<ApplicationContentConfirmationPro
         console.log('âœ… AIæ’ç‰ˆå·²åº”ç”¨åˆ°ä»»åŠ¡æ•°æ®', { assignmentId, textLength: formatted.length });
       }
 
-      // éšè—æ ¼å¼åŒ–å»ºè®®
-      setShowFormattingSuggestions(prev => ({
-        ...prev,
-        [assignmentId]: false
-      }));
-      setFormattedPreviews(prev => ({
-        ...prev,
-        [assignmentId]: ''
-      }));
+      // ğŸ”§ ä¿®å¤ï¼šç«‹å³æ›´æ–°æ‰€æœ‰çŠ¶æ€ï¼Œé˜²æ­¢é¡µé¢åˆ·æ–°å¯¼è‡´çŠ¶æ€ä¸¢å¤±
+      // ç«‹å³æ›´æ–° editedTexts çŠ¶æ€
+      setEditedTexts(prev => ({ ...prev, [assignmentId]: formatted }));
+
+      // ç«‹å³éšè—æ ¼å¼åŒ–å»ºè®®å’Œé¢„è§ˆ
+      setShowFormattingSuggestions(prev => ({ ...prev, [assignmentId]: false }));
+      setFormattedPreviews(prev => ({ ...prev, [assignmentId]: '' }));
+
+      // ğŸ”§ å¼ºåˆ¶åˆ·æ–°ä»»åŠ¡çŠ¶æ€ï¼Œç¡®ä¿æ‰€æœ‰ç›¸å…³çŠ¶æ€åŒæ­¥
+      setTask(prev => {
+        if (!prev) return prev;
+
+        const updatedAssignments = prev.assignments.map(assignment => {
+          if (assignment.id === assignmentId) {
+            // æ›´æ–° OCRç»“æœä¸­çš„ editedText å’Œ content å­—æ®µ
+            const updatedOCRResult = {
+              ...assignment.ocrResult,
+              editedText: formatted,
+              content: formatted
+            };
+
+            console.log('âœ… AIæ’ç‰ˆçŠ¶æ€å·²åŒæ­¥æ›´æ–°', {
+              assignmentId,
+              studentName: assignment.student?.name || 'æœªçŸ¥',
+              textLength: formatted.length,
+              updatedFields: ['editedText', 'content']
+            });
+
+            return {
+              ...assignment,
+              ocrResult: updatedOCRResult
+            };
+          }
+          return assignment;
+        });
+
+        // ğŸ”§ å…³é”®ï¼šå¼ºåˆ¶æ›´æ–° assignments çš„å¼•ç”¨ä»¥è§¦å‘ç»„ä»¶é‡æ–°æ¸²æŸ“
+        return {
+          ...prev,
+          assignments: [...updatedAssignments]
+        };
+      });
+
+      console.log('âœ… AIæ’ç‰ˆå·²åº”ç”¨ï¼Œæ‰€æœ‰çŠ¶æ€å·²åŒæ­¥æ›´æ–°', { assignmentId, textLength: formatted.length });
 
       console.log('âœ… AIæ’ç‰ˆå·²åº”ç”¨', { assignmentId, textLength: formatted.length });
 
@@ -498,7 +530,7 @@ const ApplicationContentConfirmation: React.FC<ApplicationContentConfirmationPro
                   {editingAssignments[assignment.id] ? (
                     <div className="space-y-2">
                       <Textarea
-                        value={editedTexts[assignment.id] || ''}
+                        value={editedTexts[assignment.id] || assignment.ocrResult.editedText || assignment.ocrResult.content || ''}
                         onChange={(e) => setEditedTexts({ ...editedTexts, [assignment.id]: e.target.value })}
                         className="min-h-[200px] text-sm"
                         placeholder="è¯·è¾“å…¥ä½œæ–‡å†…å®¹..."
@@ -584,10 +616,24 @@ const ApplicationContentConfirmation: React.FC<ApplicationContentConfirmationPro
 
                       {/* ä½œæ–‡å†…å®¹æ˜¾ç¤º */}
                       <div className="bg-gray-50 p-4 rounded border border-gray-300 text-sm text-gray-800 whitespace-pre-wrap break-words max-h-96 overflow-y-auto">
-                        {(formattedPreviews[assignment.id] && showFormattingSuggestions[assignment.id])
-                          ? formattedPreviews[assignment.id]
-                          : (assignment.ocrResult.editedText || assignment.ocrResult.content || 'æœªè¯†åˆ«åˆ°ä½œæ–‡å†…å®¹')
-                        }
+                        {(() => {
+                          // ğŸ”§ ä¿®å¤ï¼šä¼˜å…ˆçº§é€»è¾‘ - ç¡®ä¿æ˜¾ç¤ºæœ€æ–°çš„çŠ¶æ€
+                          const showPreview = formattedPreviews[assignment.id] && showFormattingSuggestions[assignment.id];
+                          const editedText = editedTexts[assignment.id];
+                          const taskEditedText = assignment.ocrResult.editedText;
+                          const taskContent = assignment.ocrResult.content;
+
+                          // ä¼˜å…ˆçº§ï¼šé¢„è§ˆ > editedTexts > task.editedText > task.content
+                          if (showPreview) {
+                            return formattedPreviews[assignment.id];
+                          } else if (editedText && editedText !== taskEditedText) {
+                            return editedText;
+                          } else if (taskEditedText) {
+                            return taskEditedText;
+                          } else {
+                            return taskContent || 'æœªè¯†åˆ«åˆ°ä½œæ–‡å†…å®¹';
+                          }
+                        })()}
                       </div>
 
                       {/* AIæ’ç‰ˆé¢„è§ˆæç¤º */}
@@ -623,10 +669,18 @@ const ApplicationContentConfirmation: React.FC<ApplicationContentConfirmationPro
                 setBatchFormattingInProgress(true);
 
                 try {
-                  // æ˜¾ç¤ºæç¤ºä¿¡æ¯
+                  // æ˜¾ç¤ºæç¤ºä¿¡æ¯ - æ™ºèƒ½æ£€æµ‹ï¼šæ’é™¤å·²ç»æ’ç‰ˆè¿‡çš„å†…å®¹
                   const needsFormattingCount = currentAssignments.filter(assignment => {
                     const text = assignment.ocrResult.editedText || assignment.ocrResult.content;
-                    return needsFormatting(text);
+                    const isAlreadyFormatted = !needsFormatting(text);
+
+                    console.log(`ğŸ” æ£€æµ‹ä½œæ–‡æ ¼å¼: ${assignment.student.name}`, {
+                      textLength: text.length,
+                      needsFormatting: !isAlreadyFormatted,
+                      hasEditedText: !!assignment.ocrResult.editedText
+                    });
+
+                    return !isAlreadyFormatted;
                   }).length;
 
                   if (needsFormattingCount > 0) {
diff --git a/src/app/tools/writing/batch-applicationwriting-polish/components/BatchImageUploader.tsx b/src/app/tools/writing/batch-applicationwriting-polish/components/BatchImageUploader.tsx
index 6110922..8f0a620 100644
--- a/src/app/tools/writing/batch-applicationwriting-polish/components/BatchImageUploader.tsx
+++ b/src/app/tools/writing/batch-applicationwriting-polish/components/BatchImageUploader.tsx
@@ -444,9 +444,10 @@ const BatchImageUploader: React.FC<BatchImageUploaderProps> = ({
     // å°†æ‰€æœ‰å›¾ç‰‡çŠ¶æ€è®¾ç½®ä¸ºå¤„ç†ä¸­
     setUploadedImages(prev => prev.map(img => ({ ...img, status: 'processing' })));
 
-    // æ˜¾ç¤ºè¿›åº¦æé†’ - åŸºäºä¼˜åŒ–åçš„å¹¶å‘é…ç½®æ›´æ–°æ—¶é—´ä¼°ç®—
-    const estimatedMinutes = Math.ceil(uploadedImages.length / 8) + 1; // 8å¼ å›¾ç‰‡çº¦1åˆ†é’Ÿï¼ŒåŠ ä¸Šæ‰¹æ¬¡é—´å»¶è¿Ÿ
-    const message = `AIè¯†å›¾ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…... é¢„è®¡${uploadedImages.length}å¼ å›¾ç‰‡å¤§çº¦éœ€è¦${estimatedMinutes}åˆ†é’Ÿï¼ˆæ€§èƒ½å·²ä¼˜åŒ–ï¼‰ã€‚`;
+    // æ˜¾ç¤ºè¿›åº¦æé†’ - åŸºäº26å¼ è¶…çº§å¹¶è¡Œå¤„ç†çš„æ€§èƒ½æ›´æ–°æ—¶é—´ä¼°ç®—
+    // ä¿å®ˆä¼°è®¡ï¼š26å¼ å¹¶å‘ï¼Œå¹³å‡æ¯å¼ 10ç§’ï¼Œæ‰¹æ¬¡é—´å»¶è¿Ÿ30ç§’
+    const estimatedMinutes = Math.max(1, Math.ceil((uploadedImages.length * 10) / 60) + Math.ceil(uploadedImages.length / 26));
+    const message = `AIè¶…çº§å¹¶è¡Œå¤„ç†ä¸­... é¢„è®¡${uploadedImages.length}å¼ å›¾ç‰‡å¤§çº¦éœ€è¦${estimatedMinutes}åˆ†é’Ÿï¼ˆ${Math.min(26, uploadedImages.length)}å¼ åŒæ—¶å¤„ç†ï¼Œæ€§èƒ½å¤§å¹…ä¼˜åŒ–ï¼‰ã€‚`;
     console.log(`ğŸ¯ ${message}`);
 
     // è®¾ç½®è¿›åº¦æ¶ˆæ¯
-- 
2.51.0.windows.1


From f9aa9caba3c528494a3ea9c749458338e6ef0a41 Mon Sep 17 00:00:00 2001
From: fredgao <547738395@qq.com>
Date: Wed, 5 Nov 2025 01:33:25 +0800
Subject: [PATCH 2/2] =?UTF-8?q?fix:=20=E4=BF=AE=E5=A4=8DhandleSave?=
 =?UTF-8?q?=E5=87=BD=E6=95=B0=E4=B8=AD=E7=9A=84=E5=85=B3=E9=94=AE=E5=8F=98?=
 =?UTF-8?q?=E9=87=8F=E5=90=8D=E9=94=99=E8=AF=AF?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

ğŸ› ä¿®å¤å…³é”®bugï¼š
- handleSaveå‡½æ•°ä¸­ä½¿ç”¨äº†é”™è¯¯çš„å˜é‡å assignment.id è€Œä¸æ˜¯ assignmentId
- è¿™å¯¼è‡´ä¿å­˜åŠŸèƒ½æ— æ³•æ­£ç¡®è·å–ç¼–è¾‘åçš„æ–‡æœ¬å†…å®¹
- æ˜¯ç”Ÿäº§ç¯å¢ƒæ’ç‰ˆåŠŸèƒ½å¤±æ•ˆçš„æ ¹æœ¬åŸå› 

Technical Details:
- ç¬¬92è¡Œï¼šeditedTexts[assignment.id] â†’ editedTexts[assignmentId]
- ç¡®ä¿å‚æ•°æ­£ç¡®ä¼ é€’ï¼Œé¿å…undefinedå€¼é—®é¢˜
---
 .../components/ApplicationContentConfirmation.tsx               | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/app/tools/writing/batch-applicationwriting-polish/components/ApplicationContentConfirmation.tsx b/src/app/tools/writing/batch-applicationwriting-polish/components/ApplicationContentConfirmation.tsx
index 32a3510..b046f09 100644
--- a/src/app/tools/writing/batch-applicationwriting-polish/components/ApplicationContentConfirmation.tsx
+++ b/src/app/tools/writing/batch-applicationwriting-polish/components/ApplicationContentConfirmation.tsx
@@ -89,7 +89,7 @@ const ApplicationContentConfirmation: React.FC<ApplicationContentConfirmationPro
   const handleSave = (assignmentId: string) => {
     if (!task) return;
 
-    const newText = editedTexts[assignment.id];
+    const newText = editedTexts[assignmentId];
     if (newText !== undefined) {
       const updatedAssignments = task.assignments.map(assignment => {
         if (assignment.id === assignmentId) {
-- 
2.51.0.windows.1

