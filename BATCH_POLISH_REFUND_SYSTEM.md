# 批量润色失败退款机制

## 📋 功能概述

为批量作业润色功能添加了智能退款机制，当润色处理失败时自动退还对应的点数给用户，确保用户不会因为系统错误而损失点数。

## 🔧 退款规则

### 1. 按学生计费退款
- **计费标准**：每个学生 1.5 点数（向上取整）
- **退款标准**：每个失败学生退还 1.5 点数（向上取整）
- **失败判定**：该学生的所有句子润色都失败（confidence = 0）

### 2. 退款场景

#### 场景一：部分学生失败
- **条件**：部分学生润色成功，部分失败
- **处理**：只退还失败学生对应的点数
- **通知**：显示失败学生名单和退还点数

#### 场景二：全部学生失败
- **条件**：所有学生润色都失败
- **处理**：退还所有点数
- **通知**：提示全部失败并退还所有点数

#### 场景三：系统错误
- **条件**：整个润色过程发生系统异常
- **处理**：退还所有扣除的点数
- **通知**：提示系统错误并退还点数

## 🛠️ 技术实现

### 1. 失败检测逻辑

```typescript
// 检查学生是否完全失败
const failedStudents = updatedAssignments.filter(assignment => {
  // 检查该学生的所有句子是否都失败了（confidence为0表示失败）
  const allSentencesFailed = assignment.polishedSentences.every(s => s.confidence === 0);
  return allSentencesFailed;
});
```

### 2. 退款计算

```typescript
const failedStudentCount = failedStudents.length;
const refundPoints = Math.ceil(failedStudentCount * 1.5); // 每个失败学生退还1.5点数，向上取整
```

### 3. 退款执行

```typescript
await SupabasePointsService.addPoints(
  currentUser.id,
  refundPoints,
  'REFUND',
  `批量润色失败退款 - ${failedStudentCount}个学生失败，退还${refundPoints}点数`
);
```

## 📊 退款示例

### 示例1：5个学生，2个失败
- **扣除点数**：Math.ceil(5 * 1.5) = 8 点数
- **失败学生**：2个
- **退还点数**：Math.ceil(2 * 1.5) = 3 点数
- **实际消费**：8 - 3 = 5 点数（3个成功学生）

### 示例2：3个学生，全部失败
- **扣除点数**：Math.ceil(3 * 1.5) = 5 点数
- **失败学生**：3个
- **退还点数**：Math.ceil(3 * 1.5) = 5 点数
- **实际消费**：0 点数

### 示例3：系统错误
- **扣除点数**：任意数量
- **退还点数**：全部扣除的点数
- **实际消费**：0 点数

## 🔍 错误处理机制

### 1. API错误处理
- **句子级别**：单个句子润色失败时，返回原句并标记失败
- **学生级别**：学生所有句子都失败时，标记该学生为失败
- **系统级别**：整个处理过程异常时，触发全额退款

### 2. 退款失败处理
- **记录日志**：详细记录退款失败的原因
- **用户通知**：提示用户联系客服处理
- **数据保留**：保留失败信息供后续处理

## 🚨 安全保障

### 1. 防重复退款
- 每次处理只执行一次退款操作
- 退款记录包含详细的描述信息

### 2. 退款审计
- 所有退款操作都记录在 `point_transactions` 表中
- 类型标记为 `REFUND`，便于后续审计

### 3. 异常监控
- 详细的错误日志记录
- 退款失败时的备用处理机制

## 📝 用户体验优化

### 1. 实时通知
- 处理完成后立即显示退款信息
- 区分部分失败和全部失败的提示

### 2. 透明度
- 明确显示失败的学生名单
- 清楚说明退还的点数数量

### 3. 客服支持
- 退款失败时提供客服联系提示
- 保留详细的错误信息供客服处理

## 🔧 维护说明

### 1. 监控指标
- 退款率：失败退款次数 / 总处理次数
- 退款金额：每日/每月退款点数统计
- 失败原因：API错误、系统错误等分类统计

### 2. 优化建议
- 定期检查API稳定性
- 优化错误处理逻辑
- 改进用户提示信息

## 📅 更新日期

- **实现时间**：2025-11-03
- **版本**：v1.0
- **状态**：已部署

---

✅ 批量润色失败退款机制已完整实现，确保用户权益得到保障



